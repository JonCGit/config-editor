# Azure Pipelines POC

trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'

- task: InstallSSHKey@0
  inputs:
    knownHostsEntry: 'github.com'
    sshKeySecureFile: 'id_rsa'
  condition: false  # Placeholder - remove if using SSH

- task: PowerShell@2
  displayName: 'Create GitHub Issue and Assign to Copilot'
  inputs:
    targetType: 'inline'
    script: |
      # Get token from service connection
      $serviceConnection = "JonCGit"
      
      # Use the GitHub CLI with the service connection token
      $env:GH_TOKEN = "$(JonCGit_Token)"
      
      # Create a new issue in the microsoft/AI-First-Development repository
      $issueUrl = gh issue create `
        --repo microsoft/AI-First-Development `
        --title "Automated Issue from Azure Pipeline - $(Build.BuildNumber)" `
        --body "This issue was automatically created by Azure Pipeline build $(Build.BuildNumber) on $(Get-Date)
      
      Build ID: $(Build.BuildId)
      Build Reason: $(Build.Reason)
      Source Branch: $(Build.SourceBranch)
      Commit: $(Build.SourceVersion)"
      
      # Extract issue number from URL
      $issueNumber = $issueUrl -replace '.*/', ''
      
      Write-Host "Created issue #$issueNumber: $issueUrl"
      
      # Assign to GitHub Copilot (using the copilot bot username)
      gh issue edit $issueNumber `
        --repo microsoft/AI-First-Development `
        --add-assignee "copilot"
      
      Write-Host "Issue assigned to GitHub Copilot"
  env:
    JonCGit_Token: $(JonCGit)
